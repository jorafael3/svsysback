/*!
	JQuery XML Store / Shop - Shopping Cart
	Created by LivelyWorks - http://livelyworks.net

 */

//var _providerIdSearch = "";
//var _convenioIdSearch = "";
var mapProviders = new Object();
var distributionsInMemory = null;
var typeInMemory = "";
// lista de resultados de produtos
// 1 = lista
// 2 = cuadricula
var verPor = 2;

function escapeRegExp(str) {
	return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}

function replaceAll(str, find, replace) {
	return str.replace(new RegExp(escapeRegExp(find), "g"), replace);
}

var superReloadFunctions = reloadFunctions;
reloadFunctions = function () {
	superReloadFunctions();

	$(".btn.btn-anadir").click(handleAnadirButton);
	//$("#btn_finalizar_compra").click(handleFinalizarCompra);
	//$("#btn_finalizar_compra_2").click(handleFinalizarCompra_2);

	$("#divConteudo_2").keypress(function (e) {
		if (isEnter(e)) {
			$(this).find(".btn-carretilla:visible").click();
			e.preventDefault();
			return false;
		}
	});


	if (!isVerPorCuad()) {
		configureInputCounter(".input-count-item");
	}

	validateOpenModal();
};

function configureInputCounter(idComponent) {
	$(idComponent).find('.menos').unbind();
	$(idComponent).find('.menos').click(function () {
		var inputCount = this.parentElement;
		var inputCantidad = $(inputCount).find('.productCantidad');

		var cantidadMin = parseFloat($(inputCount).attr('cantidadMin') > 0 ? $(inputCount).attr('cantidadMin') : "0");
		var multiplo = parseFloat($(inputCount).attr('cantidadMul') > 0 ? $(inputCount).attr('cantidadMul') : "1");
		var actualValue = parseFloat($(inputCantidad).val());
		var calculo = actualValue - multiplo;
		var resultado = "";
		if (actualValue >= "0" && calculo >= cantidadMin) {
			resultado = calculo;
		} else {
			resultado = cantidadMin;
		}

		resultado = resultado % 1 === 0 ? resultado.toFixed(0) : resultado.toFixed(2);
		$(inputCantidad).val(resultado);
	});
	$(idComponent).find('.mas').unbind();
	$(idComponent).find('.mas').click(function () {
		var inputCount = this.parentElement;
		var inputCantidad = $(inputCount).find('.productCantidad');
		var cantidadMin = parseFloat($(inputCount).attr('cantidadMin') > 0 ? $(inputCount).attr('cantidadMin') : "0");
		var cantidadMax = parseFloat($(inputCount).attr('cantidadMax') > 0 ? $(inputCount).attr('cantidadMax') : "999999");
		var multiplo = parseFloat($(inputCount).attr('cantidadMul') > 0 ? $(inputCount).attr('cantidadMul') : "1");
		var actualValue = parseFloat($(inputCantidad).val());
		var calculo = actualValue + multiplo;
		var resultado = "";

		if (calculo <= cantidadMax) {
			if (calculo < cantidadMin) {
				resultado = cantidadMin;
			} else {
				resultado = calculo;
			}
		} else {
			resultado = cantidadMax;
		}

		resultado = resultado % 1 === 0 ? resultado.toFixed(0) : resultado.toFixed(2);
		$(inputCantidad).val(resultado);
	});

	$(idComponent).find('.productCantidad').unbind();
	$(idComponent).find('.productCantidad').blur(function () {
		var inputCount = this.parentElement;
		var inputCantidad = $(inputCount).find('.productCantidad');
		var cantidadMin = parseFloat($(inputCount).attr('cantidadMin') > 0 ? $(inputCount).attr('cantidadMin') : "0");
		var cantidadMax = parseFloat($(inputCount).attr('cantidadMax') > 0 ? $(inputCount).attr('cantidadMax') : "999999");
		var multiplo = parseFloat($(inputCount).attr('cantidadMul') > 0 ? $(inputCount).attr('cantidadMul') : "1");
		var actualValue = parseFloat($(inputCantidad).val());

		if ((actualValue / multiplo).toFixed(2) % 1 != 0) {
			var mod = actualValue % multiplo;
			actualValue -= mod.toFixed(2);
		}

		if (actualValue < cantidadMax) {
			if (actualValue < cantidadMin) {
				resultado = cantidadMin;
			} else {
				resultado = actualValue;
			}
		} else {
			resultado = cantidadMax;
		}

		resultado = resultado % 1 === 0 ? resultado.toFixed(0) : resultado.toFixed(2);
		$(inputCantidad).val(resultado);

	});
}

function openModalcookies() {
	$("#modalCookies").modal('show');
	$("#cookieContainer").html("");
	var modalContent = $("#modalCookies");
	modalContent.on('click', function (event) {
		event.stopPropagation();
	});

	var data = "<p>CONSTRUMERCADO S.A. (“DISENSA”) utiliza cookies para mejorar su experiencia de navegación por la web, ofrecer contenidos personalizados, proporcionar funciones de redes sociales y analizar el tráfico de nuestro sitio web. Estas cookies también pueden ser utilizadas por terceros proveedores. Desde las siguientes opciones puede gestionar sus preferencias. Obtenga más información sobre nuestra Política de cookies: Al aceptar nuestras cookies, usted acepta que se recopile información por nosotros y por parte terceros en la plataforma. Ajuste su configuración de cookies abajo. Lea nuestra";
	data += '<a href="https://www.portaldisensa.com/imagens_cr/disensa/Politica_de_cookies_Disensa.pdf"> política de cookies</a><p>';
	$("#cookieContainer").html(data);

	$("#btns-cookies").html("");

	var button1 = $('<button id="ajustes_cookies" type="button" class="btn btn-tertiary mb-2" onclick="configurationCookies()">Ajustes</button>');

	$("#btns-cookies").append(button1);

	var button2 = $('<button id="aceptar_Cookies" type="button" class="btn btn-quaternary mb-2 ml-2" onclick="allowAllCookies()">Aceptar Todo</button>');
	$("#btns-cookies").append(button2);


}


function configurationCookies() {
	$("#modalCookies").modal('show');
	$("#cookieContainer").html("");

	var cookies = [
		{ nombre: 'requiredCookies', texto: 'Estas cookies no son opcionales. Son necesarias para que funcione la web.', cookie: 'Necesarias' },
		{ nombre: 'statisticalCookies', texto: 'Para que podamos la funcionalidad y la estructura de la web, en base como se use la web.', cookie: 'Estadisticas' },
		{ nombre: 'marketingCookies', texto: 'Al compartir tus intereses y comportamiento mientras visitas nuestro sitio, aumentas la posivilidad de ver contenidos y ofertas personalisadas.', cookie: 'Marketing' }
	];

	// Agregar checkboxes al modal
	for (var i = 0; i < cookies.length; i++) {
		var h2 = $('<h5>').css({
			'padding-left': '10px',
			'padding-top': '10px'
		}).text(cookies[i].cookie);
		var checkbox = $('<input type="checkbox" name="' + cookies[i].nombre + '">');
		var texto = $('<span class="slider round"></span>');
		var label = $('<label class="switch">').append(checkbox).append(texto);
		var div = $('<div>').css('padding-left', '10px').text(cookies[i].texto);
		var row = $('<div>').addClass('row').css('margin', '1rem').append(label, div);

		if (i === 0) {
			checkbox.prop('checked', true);
			checkbox.prop('disabled', true);
		}
		$('#cookieContainer').append(h2, row);
	}

	$("#btns-cookies").html("");

	var button1 = $('<button id="ajustes_cookies" type="button" class="btn btn-tertiary mb-2" >Guardar</button>');
	$("#btns-cookies").append(button1);

	var button2 = $('<button id="aceptar_Cookies" type="button" class="btn btn-quaternary mb-2 ml-2" onclick="allowAllCookies()">Aceptar Todo</button>');
	$("#btns-cookies").append(button2);
	button1.click(function () {
		var valores = {};
		var currentDate = new Date();
		localStorage.setItem('cookiesDate', currentDate);
		$('input[type="checkbox"]').each(function () {
			console.log(valores[$(this).attr('name')], $(this).prop('checked'));
			localStorage.setItem($(this).attr('name'), $(this).prop('checked'));
		});
		$("#modalCookies").modal("hide");
	});
}

function validateOpenModal() {
	var date = localStorage.getItem("cookiesDate");
	if (date !== null) {
		var newDate = new Date(date);
		var currentDate = new Date();
		var diferenciaEnMilisegundos = currentDate - newDate;
		var diferenciaEnDias = Math.floor(diferenciaEnMilisegundos / (1000 * 60 * 60 * 24));
		if (diferenciaEnDias == 30) {
			openModalcookies();
		}
	} else {
		openModalcookies();
	}
}

function allowAllCookies() {
	var currentDate = new Date();
	localStorage.setItem('cookiesDate', currentDate);
	localStorage.setItem('requiredCookies', true);
	localStorage.setItem('statisticalCookies', true);
	localStorage.setItem('marketingCookies', true);
	$("#modalCookies").modal("hide");
}

function handleFinalizarCompra() {
	$("#agregado_container").fadeOut(400, function () { closeCantidadPopup(); /* $("#agregar_container").fadeIn(); */ });
}

function handleFinalizarCompra_2() {
	$("#agregado_container_2").fadeOut(400, function () { /* $("#agregar_container_2").fadeIn(); */ });
}

function closeCantidadPopup() {
	$("#productoDetalle").modal("hide");
}

function containsKey(catKeys, catId) {
	var has = false;

	var split = catKeys.split(",");
	split.map(function (item) {
		item = item.replace(" ", "");
		if (item == catId)
			has = true;
	});

	return has;
}


function startDiv(div) {
	div.empty();
}

function isVerPorCuad() {
	return (!verPor || verPor == 2);
}

function createInnerDiv(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo) {
	if (isVerPorCuad()) {
		return createInnerDivCuad(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo);
	} else {
		return createInnerDivLista(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo);
	}
}

function insertHeaderFooter(innerDivs) {
	if (isVerPorCuad()) {
		return insertHeaderFooterCuad(innerDivs);
	} else {
		return insertHeaderFooterLista(innerDivs);
	}
}

// 2b- (lista) create each inner div with product of category [catId]
function createInnerDivLista(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo) {
	var innerDiv = "";

	var multiplo = productUnitMultiplo > 0 ? formatNumber(productUnitMultiplo) : "1";
	var cantidadeMax = productUnitMax > 0 ? productUnitMax : "";
	var div = `
	<tr class="lista_producto">
	    <td style="min-width: 170px;">
	        <div class="input-count input-count-item" id="inputCount" data-toggle="tooltip" data-placement="bottom" title="M&uacute;ltiplo de compra: ${multiplo}" cantidadMax="${productUnitMax}" cantidadMul="${productUnitMultiplo}">
	            <button class="menos">
	                <i class="fas fa-minus-circle"></i>
	            </button>
	            <input class="form-control ml-2 mr-2 cantidad productCantidad" type="number" name="cantidadLista" value="0" max="${cantidadeMax}" step="${multiplo}" >
	            <button class="mas">
	                <i class="fas fa-plus-circle"></i>
	            </button>
	        </div>
	    </td>
	    <td class="text-center">
	    	<select name='_unidCompra' class="form-control">
	    		${unidCompraHtml}
	    	</select>
	    </td>
	    <td class="text-center"><span id="${productID}">${productID}</span></td>
	    <td class="text-center productName" ><a href='javascript:void(0);' onClick='loadProducto(${productID});'  name='prodName'>${productName}</a></td>
	    <td class="text-center ProductPrice">$<span class="productPrice">${productPrice}</span></td>
	    <td class="text-center">
	        <select class="form-control" name="_bodega" id="">
	            ${bodegaHtml}
	        </select>
	    </td>
	    <td class="text-center">
	        <select class="form-control hidden" name="_tpEntrDisen" id="">
	            ${tpEntrDisenHtml}
	        </select>
	        <select class="form-control" name="_tpEntrProv" id="">
	        	${tpEntrProvHtml}
	        </select>
	    </td>
	    <td class="text-center">
	    	<button class="btn btn-primary btn-anadir" data-toggle='modal' data-target='#productoDetalle' >A&ntilde;adir</button>
	    	<input type='hidden' class='productUnitMultiplo' value='${productUnitMultiplo}' />
	    	<input type='hidden' class='productUnitMax' value='${productUnitMax}' />
	    	<input type='hidden' class='lifnr' value='${providerID}' />
	    	<input type='hidden' class='proveedor' value='${providerName}' />
	    	<input type='hidden' class='codigo_txt' value='${productID}' />
	    	<img class='productImage hidden' id='img_${productID}' src='${productImg}' />
	    </td>
	</tr>
	`;

	innerDiv = div;

	return innerDiv;

}

// 2a- (quadricula) create each inner div with product of category [catId]
function createInnerDivCuad(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo) {
	var innerDiv = "";
	var promoHidden = "";
	if ("X" != productPromo) {
		promoHidden = "hidden";
	}

	var div = `
		<div class="grid-card cuadro_producto" productID="${productID}">
	    	<div class="img-card-big productImage" style="background-image: url(${productImg})" src="${productImg}"></div>
	    	<span class="sale ${promoHidden}" >PROMO</span>
	    	<h5 class="card-title" name='prodName'><a class="produtoDetalheLink" href="javascript:void(0);" onClick="loadProducto(${productID});"> ${productName}</a></h5>
	    	<p class="card-text">Desde &#36; <span class="productPrice">${productPrice}</span></p>
	    	<button type="button" class="btn btn-primary btn-anadir" data-toggle="modal" data-target="#productoDetalle">A&ntilde;adir a la carretilla</button>
	    	<input type='hidden' class='productUnitMultiplo' value='${productUnitMultiplo}' />
	    	<input type='hidden' class='productUnitMax' value='${productUnitMax}' />
	    	<input type='hidden' class='lifnr' value='${providerID}' />
	    	<input type='hidden' class='codigo_txt' value='${productID}' />
	    	<input type='hidden' class='proveedor' value='${providerName}' />
	    	<select name='_bodega' style='display:none;'>
	    		${bodegaHtml}
	    	</select>
	    	<select name='_tpEntrProv' style='display:none;'>
	    		${tpEntrProvHtml}
	    	</select>
	    	<select name='_tpEntrDisen' style='display:none;'>
				${tpEntrDisenHtml}
			</select>
	    	<select name='_unidCompra' style='display:none;'>
	    		${unidCompraHtml}
	    	</select>
	    </div>
	`;

	innerDiv = div;

	return innerDiv;
}

function loadProducto(produtoId) {
	var url = "../b2b/producto.do?codigo=" + produtoId;

	if (canAjax()) {
		$.ajax({
			url: url,
			dataType: "html",
			success: function (html) {
				loadDistributions(produtoId, "detalhe");
				var divSrc = $(html).find("#divProducto");
				hidePaginacaoOrdenacao();
				$("#divConteudoOuter").hide();
				$("#divConteudo").html("");
				$("#divConteudo").html(html);

				configureInputCounter(".productCantidadDetalle");
				$("#btn-detalhe-agregar").click(handleAgregarDetalhe);
				$("#btn-detalhe-agregar-finalizar").click(handleAgregarEFinaliozarDetalhe);
				$("#btnSeguirComprandoDet").on("click", seguirComprandoOnDetalhe);
				$("#btnFinalizarCompraDet").on("click", finalizarCompraOnDetalhe);

				reloadFunctions();
			}
		});
	}
}

function loadProductoDetalheOnIndex(produtoId) {
	var url = "../b2b/producto.do?codigo=" + produtoId;

	if (canAjax()) {
		$.ajax({
			url: url,
			dataType: "html",
			success: function (html) {
				var divSrc = $(html).find("#divProducto");
				hidePaginacaoOrdenacao();
				$("#divConteudoOuter").hide();
				$("#divConteudo").html("");
				$("#mainSection").html(html);

				configureInputCounter(".productCantidadDetalle");
				$("#btn-detalhe-agregar").click(handleAgregarDetalhe);
				$("#btn-detalhe-agregar-finalizar").click(handleAgregarEFinaliozarDetalhe);
				$("#btnSeguirComprandoDet").on("click", seguirComprandoOnDetalhe);
				$("#btnFinalizarCompraDet").on("click", finalizarCompraOnDetalhe);

				reloadFunctions();
			}
		});
	}
}

function hidePaginacaoOrdenacao() {
	$("#divOrdenacao").hide();
	$("#divPaginacaoCheckout").hide();
	$("#divPaginacaoCheckout2").hide();
}
function showPaginacaoOrdenacao() {
	$("#divOrdenacao").fadeIn(200);
	$("#divPaginacaoCheckout").fadeIn(200);
	$("#divPaginacaoCheckout2").fadeIn(200);
}

function insertHeaderFooterLista(innerDivs) {

	var headerAndFooter = `
	  <div class="row mb-5">
        <div class="col-12">
          <div class="text-right">
            <div class="d-flex justify-content-end align-items-center flex-xl-row flex-lg-row flex-md-column flex-sm-column flex-column">
              <button type="button" class="btn btn-secondary mb-2" onclick="if ($('#cart_total_item').html() != 0) { location.href = 'zCheckout.do'; }">Ir a la carretilla</button>
            </div>
          </div>
        </div>
      </div>

	  <div class="row">
        <div class="col-12">
          <table class="table table-striped table-responsive-md table-responsive-sm table-responsive-xl">
            <thead>
              <tr>
              	<th class="text-center" scope="col">Cantidad</th>
              	<th class="text-center" scope="col">UV</th>
              	<th class="text-center" scope="col">C&oacute;rdigo</th>
              	<th class="text-center" scope="col">Producto</th>
              	<th class="text-center" scope="col">Precio</th>
              	<th class="text-center" scope="col">Bodega</th>
              	<th class="text-center" scope="col">Entrega</th>
              	<th class="text-center" scope="col">A&ntilde;adir</th>
              </tr>
           </thead>
           <tbody>
             ${innerDivs}
           </tbody>
         </table>
       </div>
     </div>
	`;

	innerDivs = headerAndFooter;

	return innerDivs;
}

// 3- insert the div id=quadricula and div class=row
function insertHeaderFooterCuad(innerDivs) {

	var headerAndFooter = `
    <div class="row">
        <div class="col-12">
            <div class="container-cards-grid">
            	${innerDivs}
            </div>
        </div>
    </div>
	`;

	innerDivs = headerAndFooter;

	return innerDivs;
}

function doProductSearch() {
	var prodNameSearch = $("#productNameSearch").val() || $("#productNameSearchModal").val();
	// var providerIdSearch = _providerIdSearch;
	// var convenioIdSearch = _convenioIdSearch;
	var providerIdSearch = $('#selectDropDownProviders').val() || $('#selectDropDownProvidersModal').val();
	var brandIdSearch = $('#selectDropDownBrands').val() || $('#selectDropDownBrandsModal').val();
	var convenioIdSearch = $('#selectConvenio').val() || $('#selectConvenioModal').val();

	loadProductsOnDiv(undefined, undefined, prodNameSearch, providerIdSearch, convenioIdSearch, undefined, undefined, brandIdSearch);
}

function doProductSearchMarca(brandIdSearch) {
	loadProductsOnDiv(undefined, undefined, undefined, undefined, undefined, undefined, undefined, brandIdSearch);
}

var array = [];

function onPageChange(page) {
	loadProductsOnDiv(array[0], array[1], array[2], array[3], array[4], array[5], page, array[6]);
}

function refreshPaginator(count, page) {
	var _rowsPerPage = parseInt($("#selectProdutosPorFolha").val());
	if (!_rowsPerPage)
		_rowsPerPage = -1;

	var _totalPages = parseInt((count - 1) / _rowsPerPage) + 1;

	if (page < 0 || _totalPages < 1 || count < 1) {
		page = undefined;
		_totalPages = 0;
	}

	var options = {
		currentPage: page,
		totalPages: _totalPages,
		numberOfPages: 3,
		size: 'large',
		alignment: 'center',
		onPageClicked: function (e, originalEvent, type, page) {
			onPageChange(page);

			// type = next or page

		},
		itemTexts: function (type, page, current) {
			switch (type) {
				case "first":
					return "Primero";
				case "prev":
					return "Anterior";
				case "next":
					return "Siguiente";
				case "last":
					return "$Uacute;ltimo";
				case "page":
					return page;
			}
		},
		shouldShowPage: function (type, page, current) {
			switch (type) {
				case "first":
				case "last":
					return false;
				default:
					return true;
			}
		}
	};

	if (_totalPages < 1) {
		$(".pagAtual").text(1);
		$(".totalPags").text(1);
	} else {
		$(".pagAtual").text(page);
		$(".totalPags").text(_totalPages);
	}

	$("#totalResultado").text(count);

	$("#divPaginacao").bootstrapPaginator(options);
	$("#divPaginacao").addClass("d-flex justify-content-center align-items-center flex-xl-row flex-lg-row flex-md-row flex-sm-row flex-row");

	if (count > 0) {
		$("#divPaginacaoCheckout").show();
	}

	$("body").get(0).scrollIntoView();
}

function showCheckoutButton(newStatus) {
	var obj = $("#divCheckout");
	if (newStatus) {
		obj.show();
		$("#divPaginacaoCheckout").show();
		$("#divOrdenacao").show();
	}
	else {
		obj.hide();
		$("#divPaginacaoCheckout").hide();
		$("#divOrdenacao").hide();
	}
}

function matchProductNameOrCode(code, prodName, codeOrProdNameSearch) {
	var matches = 1;

	if (codeOrProdNameSearch != undefined) {
		var codeProdName = code + " - " + prodName;
		if (codeProdName == codeOrProdNameSearch.trim()) {
			return matches;
		}

		if (codeOrProdNameSearch.trim().length > 0) {
			matches = 0;
			var searchSplitted = codeOrProdNameSearch.trim().split(" ");

			if ($(searchSplitted).length > 1) {
				var resultsFound = 0;
				$(searchSplitted).each(function (index, fieldValue) {
					var matcherSplitted = new RegExp(fieldValue.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&"), "i");
					if (matcherSplitted.test(code)) {
						resultsFound++;
					} else if (matcherSplitted.test(prodName)) {
						resultsFound++;
					}
				});

				if (resultsFound == $(searchSplitted).length) {
					matches = 1;
				}
			} else {
				var matcher = new RegExp(codeOrProdNameSearch.trim().replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&"), "i");
				if (matcher.test(code)) {
					matches = -1;
				} else if (matcher.test(prodName)) {
					matches = 1;
				}
			}
		}
	}

	return matches;
}

function isDateBeforeInDays(date, dias) {
	var isBefore = false;
	var today = new Date();

	var dateInThePast = new Date(today - (1000 * 60 * 60 * 24 * dias));
	dateInThePast.setHours(0);
	dateInThePast.setMinutes(0);
	dateInThePast.setSeconds(0);
	dateInThePast.setMilliseconds(0);


	if (date >= dateInThePast) {
		isBefore = true;
	}

	return isBefore;
}

function loadProductsOnDiv(catId, catName, prodNameSearch, providerIdSearch, convenioIdSearch, doNewProductsSearch, page, brandIdSearch) {
	marcarCategoria(catId);

	//	if (!canAjax()) {
	//		return false;
	//	}

	showPaginacaoOrdenacao();

	var sortBy = $("#selectSortBy option:selected").val();
	if (!page) {
		page = 1;
	}

	var divId = "divConteudo";
	var div = $("#" + divId);
	if (div) {
		// 1- reset div
		startDiv(div);

		var _pageNumber = -1;
		var _rowsPerPage = -1;

		_pageNumber = page;
		_rowsPerPage = parseInt($("#selectProdutosPorFolha").val());

		var prodFrom = (_pageNumber - 1) * _rowsPerPage + 1;
		var prodTo = prodFrom + _rowsPerPage - 1;

		// Load products data xml
		$.ajax({
			type: "POST",
			url: "../b2b/zCatalogoProdutos.do",
			data: { selectSortBy: sortBy },
			dataType: "html",
			error: function (xhr, ajaxOptions, thrownError) {
				refreshPaginator(0);
				alert("Error! ");
			},
			beforeSend: function () {
				showCheckoutButton(false);
			},
			complete: function () {
				showCheckoutButton(true);
			},
			success: function (data) {
				document.getElementById("productNameSearch").value = "";
				focusOffInAllInputs();
				var jQueryXMLStore = new DOMParser().parseFromString(decodeHtml(data), "text/xml");

				// counter - how many products have fulfilled the search
				// criteria
				var count = 0;
				// counter - how many from [count] have been added
				// iterated innerDivs with each product
				var innerDivs = "";
				// Product
				$(jQueryXMLStore).find("product").each(function (indexProduct, product) {
					var shouldProductAppear = false;

					var isFilterConvenio = (convenioIdSearch && convenioIdSearch != "");

					var providerID = $(product).attr("providerID");
					var convenioIDs = $(product).find("provgs").find("provg");
					var productID = $(product).attr("productID");
					var productName = $(product).attr("productName");
					var catKeys = $(product).attr("categoryKeys");
					var productDate = $(product).attr("productDate");
					var productBrand = $(product).attr("productBrand");

					var hasCategory = (catId && catId != "") ? containsKey(catKeys, catId) : true;
					var hasProvider = (providerIdSearch && providerIdSearch != "") ? providerIdSearch == providerID : true;
					var hasBrand = (brandIdSearch && brandIdSearch != "") ? brandIdSearch == productBrand : true;
					// bodega
					var hasConvenio = false;
					if (isFilterConvenio) {
						convenioIDs.each(function (i, obj) {
							if (convenioIdSearch == $(obj).attr("provgId")) {
								hasConvenio = true;
							}
						});
					} else {
						hasConvenio = true;
					}

					// nuevos productos - ultimos 3 meses
					var hasNewProducts = false;
					if (doNewProductsSearch) {
						var dias = parseInt(doNewProductsSearch);
						if (!isNaN(dias)) {
							var prodDate = fromSAPtoDate(productDate);
							prodDate.setHours(2);

							if (isDateBeforeInDays(prodDate, dias)) {
								hasNewProducts = true;
							}
						}
					} else {
						hasNewProducts = true;
					}

					var hasName = matchProductNameOrCode(productID, productName, prodNameSearch);

					shouldProductAppear = hasCategory && hasProvider && hasConvenio && hasName && hasNewProducts && hasBrand;

					if (shouldProductAppear) {
						count++;

						if (count >= prodFrom && count <= prodTo) {
							var productImg = $(product).attr("thumbPath");
							var providerID = $(product).attr("providerID");
							var productPrice = $(product).attr("productPrice");
							var productPromo = $(product).attr("productPromo");
							var providerName = mapProviders[providerID];
							if (!providerName) {
								providerName = "[NO ENCONTRADO]";
							}
							var productUnitMultiplo = getInner($(product).find("unit"));
							var productUnitMax = getInner($(product).find("unitMax"));
							var bodegaHtml = makeCombo($(product).find("provgs").find("provg"), "provgId", "provgName");
							var tpEntrProvHtml = makeCombo($(product).find("tpEntrProv").find("tpEntr"), "tpEntrId", "tpEntrName");
							var tpEntrDisenHtml = makeCombo($(product).find("tpEntrDisen").find("tpEntr"), "tpEntrId", "tpEntrName");
							var unidCompraHtml = makeCombo($(product).find("vrkmes").find("vrkme"), "vrkmeId", "vrkmeName");

							// 2- create each inner div with product of category
							// [catId]
							var innerDiv = createInnerDiv(productID, productName, providerID, providerName, productImg, productUnitMultiplo, productUnitMax, bodegaHtml, tpEntrProvHtml, tpEntrDisenHtml, unidCompraHtml, productPrice, productPromo);
							// found by name
							innerDivs += innerDiv;
						} else if (count > prodTo) {
							// sair do each
						}
					}
				});

				// 3- insert the div id=quadricula and div class=row
				innerDivs = insertHeaderFooter(innerDivs);
				div.append(innerDivs);
				reloadFunctions();

				prodNameSearch ? $("#nomePesquisado").text(prodNameSearch) : $("#nomePesquisado").text(catName);
				refreshPaginator(count, page);

			}
		});


	} else {
		window.console && console.log("SECTION [" + divId + "] NO ENCONTRADO! ");
	}

	// atualizando o array da �ltima pesquisa
	array = [catId, catName, prodNameSearch, providerIdSearch, convenioIdSearch, doNewProductsSearch, brandIdSearch];
	refreshPaginator(0);
	$("#mainSection").hide();
	$("#mainSection").html("");
	$(".sectionResult").show();
}

function makeCombo(objetos, attrId, attrName) {
	var options = "";
	$(objetos).each(function (id, obj) {
		var id = $(obj).attr(attrId);
		var name = $(obj).attr(attrName);
		options += "<option value='" + id + "'>" + name + "</option>";
	});
	return options;
}

function focusOffInAllInputs() {
	$(":focus").blur();
}

var availableProducts = [];

function getAvailableProducts() {
	return availableProducts;
}

function loadAvailableProductsForAutoComplete(jQueryXMLStore) {
	// Load products data xml
	// Product
	$(jQueryXMLStore).find("product").each(function (indexProduct, product) {
		var productID = $(product).attr("productID");
		var productName = $(product).attr("productName");
		var productIDName = productID + " - " + productName;

		availableProducts[availableProducts.length] = productIDName;
	});

	if ($("#productNameSearch").length > 0) {
		$("#productNameSearch").autocomplete({
			minLength: 3,
			source: getAvailableProducts()
		});
	}
}

function loadProviders(jQueryXMLStore) {
	// Load products data xml
	var html = "";
	// Provider
	$(jQueryXMLStore).find("provider").each(function (indexProvider, provider) {
		var providerName = $(provider).attr("providerName");
		var providerID = $(provider).attr("providerID");
		// html+= "\n<li>\n<a href='javascript:void(0);'
		// onClick=\"javascript:selectProvider('" + providerID + "', '" + providerName +
		// "')\">" + providerName + "\n</a>\n</li>";
		if (providerName && providerID && providerName !== "" && providerID != "") {
			html += '<option value=' + providerID + '>' + providerName + '</option>';
			// inclui no MAP para consulta posterior qdo for carregar os produtos
			mapProviders[providerID] = providerName;
		}

	});

	$("#selectDropDownProviders").append(html);
	$("#selectDropDownProvidersModal").append(html);
}

function loadBrands(jQueryXMLStore) {
	// Load brands data xml
	var html = "";
	// Brand
	$(jQueryXMLStore).find("brand").each(function (index, brand) {
		var brandMarca = $(brand).attr("brandMarca");
		var brandDescr = $(brand).attr("brandDescr");
		html += '<option value=' + brandMarca + '>' + brandDescr + '</option>';
	});

	$("#selectDropDownBrands").append(html);
	$("#selectDropDownBrandsModal").append(html);
}

function loadCategoriesNovo(jQueryXMLStore) {

	var categoryLength = $(jQueryXMLStore).find("category").length;
	//	console.log('categoryLength: ' + categoryLength);

	var innerCategoriaHTML = '';
	// Category
	$(jQueryXMLStore).find("category").each(function (indexCategory, category) {

		var categoryKey = $(category).attr("categoryKey");
		var categoryName = $(category).attr("categoryName");

		// var subCategoryLength = $(category).find("subCategory").length;

		// itens de categoria no menu
		innerCategoriaHTML += "<div class=\"owl-item\"><button onmouseover=\"hoverButtonToChangeIcon('" + categoryKey + "-icon', 'onIcon')\"   onmouseleave=\"hoverButtonToChangeIcon('" + categoryKey + "-icon', 'offIcon')\"   class=\"megabtn\"   onclick=\"javascript: loadProductsOnDiv('" + categoryKey + "', '" + categoryName + "');\">" + categoryName + "    </button>  <i id=\"" + categoryKey + "-icon\" class=\"fas fa-angle-down\" data-name=\"" + categoryKey + "\" onmouseover=\"openMenu(this); hoverButtonToChangeIcon('" + categoryKey + "-icon', 'onIcon') \"   onmouseleave=\"hoverButtonToChangeIcon('" + categoryKey + "-icon', 'offIcon')\"   style=\"cursor: pointer;\"></i>  </div>";
		//innerCategoriaHTML += "<div class=\"owl-item\"><button data-name=\"" + categoryKey + "\" onmouseover=\"openMenu(this)\" class=\"megabtn\" onclick=\"javascript: loadProductsOnDiv('" + categoryKey + "', '" + categoryName + "');\">" + categoryName + "</button></div>";
		//innerCategoriaHTML += "<div class=\"owl-item\"><button data-name=\"" + categoryKey + "\" onclick=\"javascript: openMenu(this)\" class=\"megabtn\" ;\">" + categoryName + "</button></div>";
		var innerSubCategoriaHTML = '';
		innerSubCategoriaHTML += '<div class="megamenu d-none" id="' + categoryKey + '">';
		innerSubCategoriaHTML += '<div class="container-fluid">                      ';
		innerSubCategoriaHTML += '    <div class="row mt-5">';

		$(category).find("subCategory").each(function (indexSubCategory, subCategory) {
			var subCategoryKey = $(subCategory).attr("subCategoryKey");
			var subCategoryName = $(subCategory).attr("subCategoryName");

			// var subSubCategoryLength = $(subCategory).find("subSubCategory").length;

			innerSubCategoriaHTML += '<div class="col-xl-2 col-lg-2 col-md-4 col-sm-6 col-12 align-items-start d-flex flex-column">';
			innerSubCategoriaHTML += "<a class=\"mega-title\" href=\"javascript: loadProductsOnDiv('" + subCategoryKey + "', '" + subCategoryName + "'); \">" + subCategoryName + "</a>";

			var innerSubSubCategoriaHTML = '<hr style="width:90%">';

			$(subCategory).find("subSubCategory").each(function (indexSubSubCategory, subSubCategory) {
				var subSubCategoryKey = $(subSubCategory).attr("subSubCategoryKey");
				var subSubCategoryName = $(subSubCategory).attr("subSubCategoryName");

				innerSubSubCategoriaHTML += "<a class=\"mega-link\" href=\"javascript: loadProductsOnDiv('" + subSubCategoryKey + "', '" + subSubCategoryName + "'); \">" + subSubCategoryName + "</a>";
			});

			innerSubCategoriaHTML += innerSubSubCategoriaHTML;
			innerSubCategoriaHTML += '</div>';
		});

		innerSubCategoriaHTML += '    </div>                             '; // row
		// mt-5
		innerSubCategoriaHTML += '    <div class="megamenu-close"></div> ';
		innerSubCategoriaHTML += '  </div>                               '; // container-fluid
		innerSubCategoriaHTML += '</div>                                 '; // megamenu

		$('#slidernav').after(innerSubCategoriaHTML);

	});

	$('#menu_categorias').html(innerCategoriaHTML);
}

function numberWithCommas(x) {
	return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function showReviseCantidadError(msg, fieldToFocus) {
	var icone = "<img src='assets/img/ico_warning_big.png' width='40px' height='40px' />&nbsp;&nbsp;";
	var titulo = "Alerta"; // "Revise la Cantidad";
	showGenericModal(icone + titulo, msg, fieldToFocus, "300px");
}

function handleAgregarButtonDetalhe(evt) {
	handleAgregarButton(evt, "_2");
}

function handleAgregarButton(evt, suffix) {
	var qtd = (suffix ? 0 : 1);

	if (!canAjax(qtd)) {
		evt.preventDefault();
		return false;
	}

	if (!suffix)
		suffix = "";
	if (validateFormCanasta()) {
		disableForm("#addForm" + suffix);
		putTextToDistributionDesc();
		var msgErro = "";
		$.ajax({
			type: "POST",
			url: "../b2b/zCarrito.do",
			data: $("#addForm" + suffix).serialize() + "&prodCarrito.codigo=" + $("#codigoPopUP" + suffix).html() + "&prodCarrito.nombre=" + $("#nombrePopUP" + suffix).html() + "&prodCarrito.urlImg=" + $("#imagenPopUP" + suffix).attr("src") + "&prodCarrito.lifnr=" + $("#lifnr" + suffix).val() + "&prodCarrito.proveedor=" + $("#proveedorPopUP" + suffix).html(),
			dataType: "text",
			success: function (response) {
				if ($.isNumeric(response)) {
					var qtdItems = parseInt("" + response);
					$("#cart_total_item").html(qtdItems);
					$("#itemsNuevos" + suffix).html($("#cantidad" + suffix).val());
				} else {
					// erro de validacao
					msgErro = response;
				}

				if (msgErro != "") {
					var obj = $(msgErro);

					var divValidCantidad = $(obj).filter("#divValidCantidad");
					var divValidTipoEntrega = $(obj).filter("#divValidTipoEntrega");
					var divValidEstoque = $(obj).filter("#divValidEstoque");
					if (divValidCantidad && divValidCantidad.length > 0) {
						showReviseCantidadError(divValidCantidad.html(), "cantidad" + suffix);
					} else if (divValidTipoEntrega && divValidTipoEntrega.length > 0) {
						showReviseCantidadError(divValidTipoEntrega.html(), "tpEntr" + suffix);
					} else if (divValidEstoque && divValidEstoque.length > 0) {
						showReviseCantidadError(divValidEstoque.html(), "cantidad" + suffix);
					}
					enableForm("#addForm" + suffix);
				} else {
					closeCantidadPopup();
					showGenericModal("Mensaje", "Se han a&ntilde;adido " + $("#cantidad" + suffix).val() + " items a su carretilla", "", "400px");
				}
			}
		});
	}

}

function handleAgregarEFinalizarButton(evt, suffix) {

	var qtd = (suffix ? 0 : 1);

	if (!canAjax(qtd)) {
		evt.preventDefault();
		return false;
	}

	if (!suffix)
		suffix = "";

	if (validateFormCanasta()) {
		putTextToDistributionDesc();
		disableForm("#addForm" + suffix);

		var msgErro = "";
		$.ajax({
			type: "POST",
			url: "../b2b/zCarrito.do",
			data: $("#addForm" + suffix).serialize() + "&prodCarrito.codigo=" + $("#codigoPopUP" + suffix).html() + "&prodCarrito.nombre=" + $("#nombrePopUP" + suffix).html() + "&prodCarrito.urlImg=" + $("#imagenPopUP" + suffix).attr("src") + "&prodCarrito.lifnr=" + $("#lifnr" + suffix).val() + "&prodCarrito.proveedor=" + $("#proveedorPopUP" + suffix).html(),
			dataType: "text",
			success: function (response) {
				if ($.isNumeric(response)) {
					var qtdItems = parseInt("" + response);
					$("#cart_total_item").html(qtdItems);
					$("#itemsNuevos" + suffix).html($("#cantidad" + suffix).val());
				} else {
					// erro de validacao
					msgErro = response;
				}

				if (msgErro != "") {
					var obj = $(msgErro);

					var divValidCantidad = $(obj).filter("#divValidCantidad");
					var divValidTipoEntrega = $(obj).filter("#divValidTipoEntrega");
					var divValidEstoque = $(obj).filter("#divValidEstoque");
					if (divValidCantidad && divValidCantidad.length > 0) {
						showReviseCantidadError(divValidCantidad.html(), "cantidad" + suffix);
					} else if (divValidTipoEntrega && divValidTipoEntrega.length > 0) {
						showReviseCantidadError(divValidTipoEntrega.html(), "tpEntr" + suffix);
					} else if (divValidEstoque && divValidEstoque.length > 0) {
						showReviseCantidadError(divValidEstoque.html(), "cantidad" + suffix);
					}
					enableForm("#addForm" + suffix);
				} else {
					closeCantidadPopup();
					window.location = "zCheckout.do";
				}
			}
		});
	}
}

function handleAgregarDetalhe(evt, suffix) {
	if (validateFormCanasta()) {
		disableForm("#addFormDetalhe");
		putTextToDistributionDesc();
		var msgErro = "";
		$.ajax({
			type: "POST",
			url: "../b2b/zCarrito.do",
			data: $("#addFormDetalhe").serialize() + "&prodCarrito.codigo=" + $("#codigoDetalhe").html() + "&prodCarrito.nombre=" + encodeURIComponent($("#nombreDetalhe").text()) + "&prodCarrito.urlImg=" + $("#imagenDetalhe").attr("src") + "&prodCarrito.lifnr=" + $("#lifnr").val() + "&prodCarrito.proveedor=" + $("#proveedorDetalhe").text() + "&prodCarrito.werks=" + $("#productWerks").val() + "&prodCarrito.deposito=" + ($("#deposito").is(":checked") ? $("#deposito").val() : "PT01"),
			dataType: "text",
			success: function (response) {
				if ($.isNumeric(response)) {
					var qtdItems = parseInt("" + response);
					$("#cart_total_item").html(qtdItems);
					$("#itemsNuevos").html($("#cantidad").val());
				} else {
					// erro de validacao
					msgErro = response;
				}

				if (msgErro != "") {
					var obj = $(msgErro);
					var suffix = "_2";
					var divValidCantidad = $(obj).filter("#divValidCantidad");
					var divValidTipoEntrega = $(obj).filter("#divValidTipoEntrega");
					var divValidEstoque = $(obj).filter("#divValidEstoque");
					if (divValidCantidad && divValidCantidad.length > 0) {
						showReviseCantidadError(divValidCantidad.html(), "cantidad" + suffix);
					} else if (divValidTipoEntrega && divValidTipoEntrega.length > 0) {
						showReviseCantidadError(divValidTipoEntrega.html(), "tpEntr" + suffix);
					} else if (divValidEstoque && divValidEstoque.length > 0) {
						showReviseCantidadError(divValidEstoque.html(), "cantidad" + suffix);
					}
					enableForm("#addForm" + suffix);
				}
				else {
					$(".divAnadirButtons:visible").hide();
					$(".divButtonsPosCompraDetalhe").show()
					showGenericModal("Mensaje", "Se han a&ntilde;adido " + $("#cantidadDetalhe").val() + " items a su carretilla", "", "400px");
				}
			}
		});
	}
}

function putTextToDistributionDesc() {
	document.getElementById("distributionDesc").value = "";
	var distributionSelect = null;
	if (typeInMemory == "modal") {
		distributionSelect = document.getElementById("distributionPopUP");
	} else {
		distributionSelect = document.getElementById("distributionDetalhe");
	}

	if (distributionSelect != null && distributionSelect != undefined) {
		var options = distributionSelect.options;
		if (options != null && options != undefined && options.length > 0) {
			var distributionText = options[distributionSelect.selectedIndex].text;
			document.getElementById("distributionDesc").value = distributionText;
		}

	}
}

function handleAgregarEFinaliozarDetalhe() {

	if (validateFormCanasta()) {
		putTextToDistributionDesc();
		disableForm("#addFormDetalhe");
		var msgErro = "";
		$.ajax({
			type: "POST",
			url: "../b2b/zCarrito.do",
			data: $("#addFormDetalhe").serialize() + "&prodCarrito.codigo=" + $("#codigoDetalhe").html() + "&prodCarrito.nombre=" + encodeURIComponent($("#nombreDetalhe").text()) + "&prodCarrito.urlImg=" + $("#imagenDetalhe").attr("src") + "&prodCarrito.lifnr=" + $("#lifnr").val() + "&prodCarrito.proveedor=" + $("#proveedorDetalhe").text() + "&prodCarrito.werks=" + $("#productWerks").val() + "&prodCarrito.deposito=" + ($("#deposito").is(":checked") ? $("#deposito").val() : "PT01"),
			dataType: "text",
			success: function (response) {
				if ($.isNumeric(response)) {
					var qtdItems = parseInt("" + response);
					$("#cart_total_item").html(qtdItems);
					$("#itemsNuevos").html($("#cantidadcantidadDetalhe").val());
				} else {
					// erro de validacao
					msgErro = response;
				}

				if (msgErro != "") {
					var obj = $(msgErro);
					var suffix = "_1";
					var divValidCantidad = $(obj).filter("#divValidCantidad");
					var divValidTipoEntrega = $(obj).filter("#divValidTipoEntrega");
					var divValidEstoque = $(obj).filter("#divValidEstoque");
					if (divValidCantidad && divValidCantidad.length > 0) {
						showReviseCantidadError(divValidCantidad.html(), "cantidad" + suffix);
					} else if (divValidTipoEntrega && divValidTipoEntrega.length > 0) {
						showReviseCantidadError(divValidTipoEntrega.html(), "tpEntr" + suffix);
					} else if (divValidEstoque && divValidEstoque.length > 0) {
						showReviseCantidadError(divValidEstoque.html(), "cantidad" + suffix);
					}
					enableForm("#addForm" + suffix);
				}
				else {
					window.location = "zCheckout.do";
				}
			}
		});
	}
}

function handleAnadirButton() {
	event.stopPropagation();
	seguirComprando(true);

	var contenedor;
	var produtoDetalhe = false;

	if ($(this).closest(".cuadro_producto").length > 0) {
		contenedor = $(this).closest(".cuadro_producto");
	} else {
		if ($(this).closest(".lista_producto").length > 0) {
			contenedor = $(this).closest(".lista_producto");
		} else {
			contenedor = $(this).closest(".porta_producto_top");
			produtoDetalhe = true;
		}
	}
	var codigo = contenedor.find(".codigo_txt").val();
	var lifnr = contenedor.find(".lifnr").val();
	var proveedor = contenedor.find(".proveedor").val();
	var imagen = contenedor.find(".productImage").attr("src");
	var productUnitMultiplo = formatNumber(contenedor.find(".productUnitMultiplo").val());
	var productUnitMax = formatNumber(contenedor.find(".productUnitMax").val());
	var productPrice = contenedor.find(".productPrice").text();

	var nombre;
	var cantidad;
	var optionsBodega;
	var optionsTpEntrProv;
	var optionsTpEntrDisen;
	var optionsUnidCompra;

	if (produtoDetalhe) {
		nombre = contenedor.find("[name='prodName']").val().trim();
		optionsBodega = contenedor.find("[name='prodCarrito.locRetirada']").html();
		optionsTpEntrProv = contenedor.find("[name='prodCarrito.tpEntrProv']").html();
		optionsTpEntrDisen = contenedor.find("[name='prodCarrito.tpEntrDisen']").html();
		optionsUnidCompra = contenedor.find("[name='prodCarrito.unidadeCompra']").html();
		cantidad = contenedor.find("[name='prodCarrito.cantidad']").val().trim();
	} else {
		nombre = contenedor.find("[name='prodName']").text().trim();
		optionsBodega = contenedor.find("[name='_bodega']").html();
		optionsTpEntrProv = contenedor.find("[name='_tpEntrProv']").html();
		optionsTpEntrDisen = contenedor.find("[name='_tpEntrDisen']").html();
		optionsUnidCompra = contenedor.find("[name='_unidCompra']").html();
		cantidad = contenedor.find(".productCantidad").val() ? contenedor.find(".productCantidad").val() : 1;
		cantidad = parseFloat(productUnitMultiplo) > cantidad ? productUnitMultiplo : cantidad;
	}

	$("#codigo_form").val(codigo);
	$("#codigoPopUP").html(codigo);
	$("#nombrePopUP").html(nombre);
	$("#imagenPopUP").attr("src", imagen);
	$("#productUnitMultiplo").val(productUnitMultiplo);
	$("#productUnitMax").val(productUnitMax);
	$("#lifnr").val(lifnr);
	$("#productPricePopUP").html(productPrice);
	$("#proveedorPopUP").html(proveedor);
	$("#cantidad").val(cantidad);

	$("#bodegaPopUP").html("");
	$("#bodegaPopUP").append(optionsBodega);
	!produtoDetalhe ? $("#bodegaPopUP").val(contenedor.find("[name='_bodega']").val()) : "";

	$("#tpEntrPopUP").html("");
	if ($("#bodegaPopUP").val() == "D1") {
		$("#tpEntrPopUP").append(optionsTpEntrProv);

		!produtoDetalhe ? $("#tpEntrPopUP").val(contenedor.find("[name='_tpEntrProv']").val()) : "";

	} else if ($("#bodegaPopUP").val() == "D2") {
		$("#tpEntrPopUP").append(optionsTpEntrDisen);
		!produtoDetalhe ? $("#tpEntrPopUP").val(contenedor.find("[name='_tpEntrDisen']").val()) : "";
	}

	$("#unidCompraPopUP").html("");
	$("#unidCompraPopUP").append(optionsUnidCompra);

	configurarInputQuantidadeProdutoModal(productUnitMax, productUnitMultiplo);
	loadDistributions(codigo, "modal");

	var bodegaSelect = document.getElementById("bodegaPopUP");
	var tpEntrSelect = document.getElementById("tpEntrPopUP");

}


function loadDistributions(matnr, type) {
	typeInMemory = type;
	distributionData = null;
	var xhr = new XMLHttpRequest();
	xhr.open('GET', '/b2b_new/distribution?matnr=' + matnr, true);
	xhr.onload = function () {
		if (xhr.status === 200) {
			var distributionData = xhr.responseText;
			distributionsInMemory = distributionData;
			if (type == "modal") {
				putDistributions();
			} else {
				putDistributionsInDetail();
			}

		} else {
			console.log('Request failed.  Returned status of ' + xhr.status);
		}
	};

	xhr.send();

}



function putDistributions() {
	var distributionDataParse = null;
	if (distributionsInMemory != null && distributionsInMemory != undefined) {
		distributionDataParse = JSON.parse(distributionsInMemory);
		var bodegaSelect = document.getElementById("bodegaPopUP");
		var tpEntrSelect = document.getElementById("tpEntrPopUP");
		var distributionSelect = document.getElementById("distributionPopUP");

		var selectedBodega = bodegaSelect.value;
		var selectedTpEntr = tpEntrSelect.value;

		var filteredData = distributionDataParse.filter(function (obj) {
			return obj.provg == selectedBodega && obj.tpentrprov == selectedTpEntr;
		});

		distributionSelect.innerHTML = "";
		var putAnOption = false;
		for (var i = 0; i < filteredData.length; i++) {
			var option = document.createElement("option");
			if (putAnOption == false) {
				putAnOption = true;
			}
			option.value = filteredData[i].vsTel;
			option.text = filteredData[i].vsText;
			distributionSelect.add(option);

		}
		if (putAnOption == false) {
			document.getElementById("distributionDiv").style.display = "none";
		} else {
			document.getElementById("distributionDiv").style.display = "block";
		}

		$("#productoDetalle").on("shown.bs.modal", function () {
			$("#cantidad").focus();
		});

		$("#productoDetalle").modal("show");
	} else {
		document.getElementById("distributionDiv").style.display = "none";

		$("#productoDetalle").on("shown.bs.modal", function () {
			$("#cantidad").focus();
		});

		$("#productoDetalle").modal("show");
	}

}

function putDistributionsInDetail() {
	var distributionDataParse = null;
	if (distributionsInMemory != null && distributionsInMemory != undefined) {
		distributionDataParse = JSON.parse(distributionsInMemory);
		var bodegaSelect = document.getElementById("bodegaDetalhe");
		var tpEntrSelect = document.getElementById("tpEntrDetalhe");
		var distributionSelect = document.getElementById("distributionDetalhe");

		var selectedBodega = bodegaSelect.value;
		var selectedTpEntr = tpEntrSelect.value;

		var filteredData = distributionDataParse.filter(function (obj) {
			return obj.provg == selectedBodega && obj.tpentrprov == selectedTpEntr;
		});

		distributionSelect.innerHTML = "";
		var putAnOption = false;
		for (var i = 0; i < filteredData.length; i++) {
			var option = document.createElement("option");
			if (putAnOption == false) {
				putAnOption = true;
			}
			option.value = filteredData[i].vsTel;
			option.text = filteredData[i].vsText;
			distributionSelect.add(option);

		}
		if (putAnOption == false) {
			document.getElementById("distributionDetalheDiv").style.display = "none";
		} else {
			document.getElementById("distributionDetalheDiv").style.display = "block";
		}

	} else {
		document.getElementById("distributionDetalheDiv").style.display = "none";
	}

}

function seguirComprando(immediate, suffix) {
	if (!suffix)
		suffix = "";

	enableForm("#addForm" + suffix);

	if (immediate) {
		//$("#agregado_container" + suffix).hide();
		//$("#agregar_container" + suffix).show();
		$("#cantidad" + suffix).val("");
		$("#cantidad" + suffix).focus();
	}

}

function loadMarcas(responseHTML) {
	$("#marcas_div").html(responseHTML);

	if ($("#brandslider").length > 0) {
		if ($("#brandslider").find(".item").length > 0) {

			$('#brandslider').owlCarousel({
				loop: true,
				margin: 10,
				nav: true,
				responsive: {
					0: {
						items: 3,
						nav: false,

					},
					600: {
						items: 3,

					},
					1300: {
						items: 5,
						loop: true,
						nav: true
					}
				}
			});

			$("#marcas_div").show();
		} else {
			console.log("log: n�o h� itens de marca");
			$("#marcas_div").hide();
		}
	}
}

function produtosDestacadosCarousel() {

	if ($("#productslider1").length > 0) {
		if ($("#productslider1").find(".item").length > 0) {

			$('#productslider1').owlCarousel({
				loop: true,
				margin: 10,
				nav: true,
				responsive: {
					0: {
						items: 1,
						nav: false,

					},
					600: {
						items: 2,

					},
					1300: {
						items: 5,
						loop: true,
						nav: true
					}
				}
			});

			$("#produtosDestacadosDiv").show();
			reloadFunctions();
		} else {
			console.log("log: n�o h� itens de produtos destacados");
			$("#produtosDestacadosDiv").hide();
		}

	}
}

function produtosNovosCarousel() {

	if ($("#productslider2").length > 0) {
		if ($("#productslider2").find(".item").length > 0) {

			$('#productslider2').owlCarousel({
				loop: true,
				margin: 10,
				nav: true,
				responsive: {
					0: {
						items: 1,
						nav: false,

					},
					600: {
						items: 2,
						loop: true,
						nav: true

					},
					1300: {
						items: 5,
						loop: true,
						nav: true
					}
				}
			});

			$("#produtosNovosDiv").show();
			reloadFunctions();
		} else {
			console.log("log: n�o h� itens de produtos novos");
			$("#produtosNovosDiv").hide();
		}
	}
}

function loadBannersNovo(responseHTML) {

	var bannersAjax = $(responseHTML).filter("#banners");

	if (bannersAjax.length > 0) {
		var baseDirBanner = bannersAjax.find('#baseDirBanner').get(0);;
		$('#banners_novo_hidden').append(baseDirBanner);
		var itens = bannersAjax.find('.item');

		if (itens.length > 0) {
			itens.each(function (index) {

				var onclickFunc = $(this).find('a').attr("onclick");
				var imgUrl = $(this).find('img').attr('src');

				var html = '';
				html += '<div class="item">';
				html += '   <div class="slider-container d-flex align-items-center justify-content-center flex-xl-row flex-lx-row flex-md-column flex-sm-column flex-column banner-img"';
				html += '       style="background-image: url(' + imgUrl + ')" onclick="' + onclickFunc + '">';
				html += '       <h2 class="s-title p-3 text-white"><br><br></h2>';
				html += '       <div class="p-3">';
				html += '           <h3 class="text-white"></h3>';
				html += '           <h5 class="text-white"></h5>';
				html += '       </div>';
				html += '   </div>';
				html += '</div>';
				$('#banners_novo').append(html);

			}); // fim each itens

			$('#banners_novo').owlCarousel({
				items: 1,
				merge: true,
				loop: true,
				center: true,
				dots: true,
				animateOut: 'fadeOut',
				autoplay: true,
				autoplayTimeout: 5000,
				autoplayHoverPause: true
			});

			$("#banners_novo").show();
		} else {
			console.log("log: n�o h� itens no banner");
			$("#banners_novo").hide();
		}

	}
}

function loadNews(responseHTML) {
	var html = $(responseHTML).filter("#news").html();
	html = fixHtmlTags2(html);

	$("#news").append(html);

	$("#news").ready(function () {
		$(".link_load_historial_noticia").click(loadHistorialNoticia);
	});

}


var vistaSelectedClassName = "vista_activa";
function marcarVista(obj) {
	$(".grid-link").removeClass("active");
	$(obj).addClass("active");
}

var DIAS_POR_MES = 30;

function loadLinkNuevosProductos() {
	$(".link_nuevos_productos").click(function () {
		var id = $(this).attr("id");
		var meses = parseInt(id.replace(/link_nuevos_productos_/, ""));
		if (isQualidade)
			meses = 12;
		loadProductosFromMesesBefore(meses);
	});
}

function loadProductosFromMesesBefore(meses) {
	if (!isNaN(meses))
		loadProductsOnDiv(undefined, undefined, undefined, undefined, undefined, (meses * DIAS_POR_MES));
}

/** ON READY * */
// $(document).on("ready", onReadyDocument);
// function onReadyDocument() {
$(function () {
	showCheckoutButton(false);
	$("#divModalAnadir").keypress(function (e) {
		if (isEnter(e)) {
			$("#divAnadirButtons").find(".btn-primary:visible")[0].click();
			e.preventDefault();
			return false;
		}
	});

	$("#btn_agregar").click(handleAgregarButton);
	$("#btn_agregar_finalizar_compra").click(handleAgregarEFinalizarButton);

	$("#buttonProductSearch").keypress(function (e) {
		if (isEnter(e)) {
			doProductSearch();
		}
	});

	$('#search-form').submit(function (e) {
		e.preventDefault(e);
		doProductSearch();
	});

	$("#vista_lista").click(function () {
		verPor = 1;
		marcarVista(this);
		onPageChange();
	});
	$("#vista_cuadricula").click(function () {
		verPor = 2;
		marcarVista(this);
		onPageChange();
	});

	$("#selectSortBy").change(function () {
		onPageChange();
	});

	$("#selectProdutosPorFolha").change(function () { onPageChange(); });

	// $("#cantidad").mask("?9999", {placeholder: " ", onFocusSelect: true});
	// $("#cantidad_2").mask("?9999", {placeholder: " ", onFocusSelect: true});
	$("#cantidad").numberMask({ type: "float", afterPoint: 2, beforePoint: 4, defaultValueInput: "0", decimalMark: "." });
	$("#cantidad_2").numberMask({ type: "float", afterPoint: 2, beforePoint: 4, defaultValueInput: "0", decimalMark: "." });
	$(".cantidadItem").numberMask({ type: "float", afterPoint: 2, beforePoint: 4, defaultValueInput: "0", decimalMark: "." });

	// Load Banners and News data xml
	$.ajax({
		type: "POST",
		url: "../b2b/zBannerNoticia.do",
		dataType: "html",
		success: function (responseHTML) {
			loadBannersNovo(responseHTML);
		}
	});

	// Load Marcas
	$.ajax({
		type: "POST",
		url: "../b2b/zMarcas.do",
		dataType: "html",
		success: function (responseHTML) {
			loadMarcas(responseHTML);
			//			console.log('zMarcas');
			//			console.log(responseHTML);
		}
	});

	// Load Produtos Destacados
	$.ajax({
		type: "POST",
		url: "../b2b/zProdutosDestacados.do",
		dataType: "html",
		success: function (responseHTML) {
			$("#produtosDestacadosDiv").html(responseHTML);
			//produtosDestacadosCarousel();
		}
	});

	// Load Produtos Novos
	$.ajax({
		type: "POST",
		url: "../b2b/zProdutosNovos.do",
		dataType: "html",
		success: function (responseHTML) {
			$("#produtosNovosDiv").html(responseHTML);
			//produtosNovosCarousel();
		}
	});

	// Load products data xml
	$.ajax({
		type: "POST",
		url: "../b2b/zCatalogoProdutos.do",
		dataType: "html",
		success: function (data) {
			var jQueryXMLStore = new DOMParser().parseFromString(decodeHtml(data), "text/xml");
			// async
			loadProviders(jQueryXMLStore);
			loadBrands(jQueryXMLStore);
			loadAvailableProductsForAutoComplete(jQueryXMLStore);
			loadCategoriesNovo(jQueryXMLStore);
			loadLinkNuevosProductos();
		}
	});

	// configureInputCounterComponent in produtoDetalleModal
	configureInputCounter(".productCantidad");

	$('.btn-search-navbar').click(function () {
		$("#productNameSearchModal").val('');
		$("#selectDropDownProvidersModal").val($("#selectDropDownProvidersModal option:first").val());
		$("#selectDropDownBrandsModal").val($("#selectDropDownBrandsModal option:first").val());
		$("#selectConvenioModal").val($("#selectConvenioModal option:first").val());
	});

});
/** END ON READY * */


function limitaLabelDestaques() {
	// limita tamanho de texto nos destaques
	$('h5.card-title a').each(function () {
		var descricao = $(this).html();
		descricao = descricao.replace(/&nbsp;/g, ' ');
		descricao = descricao.replace(/[^ -~]+/g, "");
		if (descricao.length <= 40) {
			var novaDescricao = descricao.substring(0, descricao.length);
			novaDescricao = novaDescricao.trim();
			$(this).html(novaDescricao);
		}
		if (descricao.length > 40) {
			var novaDescricao = descricao.substring(0, 40);
			novaDescricao = novaDescricao.trim();
			$(this).html(novaDescricao);
		}

		$(this).prop('title', descricao);
	});
}

function getInner(jObj) {
	return jObj.text();
}

function decodeHtml(html) {
	var txt = document.createElement("textarea");
	txt.innerHTML = html;
	return txt.value;
}

function categoriaCarousel() {
	if (document.querySelector("#slidernav")) {
		$('#slidernav').owlCarousel({

			responsiveClass: true,
			stagePadding: 15,
			responsive: {
				0: {
					items: 1,
					nav: true
				},
				400: {
					items: 1,
					nav: true
				},
				500: {
					items: 2,
					nav: true
				},
				600: {
					items: 3,
					nav: true
				},
				768: {
					items: 4,
					nav: true
				},
				920: {
					items: 5,
					nav: true,
					loop: false
				},
				1300: {
					items: 7,
					nav: true,
					loop: false
				},
				1600: {
					items: 8,
					nav: true,
					loop: false
				},
				1800: {
					items: 8,
					nav: true,
					loop: false
				},
				1920: {
					items: 10,
					nav: true,
					loop: false
				}
			}
		});
	}

}

function seguirComprandoOnDetalhe() {
	window.location = "start.do";
}

function finalizarCompraOnDetalhe() {
	window.location = "zCheckout.do";
}

function validateFormCanasta() {

	var mensagem = "";
	var isValido = true;
	var quantidade = "";
	if ($("#cantidad").is(":visible")) {
		quantidade = $.trim($("#cantidad").val());
	} else if ($("#cantidadDetalhe").is(":visible")) {
		quantidade = $.trim($("#cantidadDetalhe").val());
	}
	if (quantidade.trim().length == 0) {
		mensagem += "Cantidad es obligatoria. <br />";
		isValido = false;
	} else {
		if (parseFloat(quantidade) == 0) {
			mensagem += "Cantidad es obligatoria. <br />";
			isValido = false;
		}
	}

	var unidade = "";
	if ($("#unidCompraPopUP").is(":visible")) {
		unidade = $.trim($("#unidCompraPopUP").val());
	} else if ($("#unidCompraDetalhe").is(":visible")) {
		unidade = $.trim($("#unidCompraDetalhe").val());
	}
	if (unidade.trim().length == 0) {
		mensagem += "Unidad es obligatoria. <br />";
		isValido = false;
	}

	if ($("label[for='bodega']").is(":visible")) {
		var bodega = "";
		if ($("#bodegaPopUP").is(":visible")) {
			bodega = $.trim($("#bodegaPopUP").val());
		} else if ($("#bodegaDetalhe").is(":visible")) {
			bodega = $.trim($("#bodegaDetalhe").val());
		}
		if (bodega.trim().length == 0) {
			mensagem += "Bodega es obligatorio.<br />";
			isValido = false;
		}
	}


	if ($("label[for='entrega']").is(":visible")) {
		var tpEntrega = "";
		if ($("#tpEntrPopUP").is(":visible")) {
			tpEntrega = $.trim($("#tpEntrPopUP").val());
		} else if ($("#tpEntrDetalhe").is(":visible")) {
			tpEntrega = $.trim($("#tpEntrDetalhe").val());
		}
		if (tpEntrega.trim().length == 0) {
			mensagem += "Tipo de entrega es obligatorio.<br />";
			isValido = false;
		}
	}

	if (isValido) {
		//$("#footerValidacao").hide();
	} else {
		console.log(mensagem);
		showGenericModal("Alerta", mensagem, "", "400px");
	}

	return isValido;
}

function configurarInputQuantidadeProdutoModal(qtdMax, qtdMult) {
	$("#inputCountProduto").attr("cantidadMax", qtdMax);
	$("#inputCountProduto").attr("cantidadMul", qtdMult);
	$("#inputCountProduto").find(".productCantidad").attr("max", qtdMax > 0 ? qtdMax : "");
	$("#inputCountProduto").find(".productCantidad").attr("step", qtdMult);
	configureInputCounter("#inputCountProduto");
}

function openMenu(e) {
	var elementoInicial = document.getElementsByClassName('megamenu');

	for (let i = 0; i < elementoInicial.length; i++) {
		elementoInicial[i].classList.remove('d-none');
		elementoInicial[i].classList.remove('d-block');
		elementoInicial[i].classList.add('d-none');
	}


	var nombre = e.getAttribute('data-name');
	var elemento = document.getElementById(nombre);
	elemento.classList.add('d-block');
}

//added hover change
function hoverButtonToChangeIcon(idIcon, action) {
	var iconElement = document.getElementById(idIcon);
	// var iconElement = document.getElementById(e+"-icon");
	if (iconElement != null && iconElement != undefined) {
		var color = "black";
		if (action == "onIcon") {
			color = "#f4313f";
		}
		iconElement.style.color = color
	}

}

